<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>RTD Platform</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
	<style>
		* { box-sizing: border-box; }
		body {
			margin: 0;
			font-family: 'Inter', sans-serif;
			background: #f3f4f6;
			color: #1f2937;
		}
		a { color: #b5891a; }
		header {
			background: linear-gradient(135deg, #d4af37, #b5891a);
			color: white;
			padding: 24px 32px 18px;
			box-shadow: 0 6px 20px rgba(212, 175, 55, 0.35);
		}
		header h1 {
			margin: 0;
			font-size: 28px;
			font-weight: 700;
		}
		header p {
			margin: 6px 0 0;
			font-size: 15px;
			opacity: 0.9;
		}
		main {
			padding: 16px 32px 48px;
			max-width: 1200px;
			margin: 0 auto;
		}
		.tabs {
			display: flex;
			gap: 16px;
			margin: 24px 0;
		}
		.tab-button {
			border: none;
			background: white;
			padding: 12px 20px;
			border-radius: 12px;
			font-size: 15px;
			cursor: pointer;
			box-shadow: 0 10px 20px rgba(0,0,0,0.08);
			font-weight: 600;
			color: #4b5563;
			transition: transform .2s ease, box-shadow .2s ease, background .2s ease;
		}
		.tab-button.active {
			background: linear-gradient(135deg, #d4af37, #b5891a);
			color: white;
			transform: translateY(-2px);
			box-shadow: 0 12px 24px rgba(181, 137, 26, .35);
		}
		.tab-content { display: none; }
		.tab-content.active { display: block; }
		.card {
			background: white;
			border-radius: 14px;
			box-shadow: 0 18px 30px rgba(23,37,84,.08);
			margin-bottom: 24px;
			padding: 24px;
		}
		.section-title {
			font-size: 18px;
			font-weight: 700;
			margin-bottom: 16px;
			color: #111827;
		}
		.form-grid {
			display: grid;
			gap: 16px;
			grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
		}
		label {
			display: block;
			font-size: 13px;
			font-weight: 600;
			color: #6b7280;
			margin-bottom: 6px;
		}
		input, select, textarea {
			width: 100%;
			padding: 12px 14px;
			border-radius: 10px;
			border: 1px solid #d1d5db;
			font-size: 15px;
			background: #f9fafb;
			transition: border .2s ease, box-shadow .2s ease;
		}
		input:focus, select:focus, textarea:focus {
			outline: none;
			border-color: #d4af37;
			box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.25);
		}
		textarea { resize: vertical; min-height: 90px; }
		button.primary {
			border: none;
			background: linear-gradient(135deg, #d4af37, #b5891a);
			color: white;
			padding: 12px 24px;
			border-radius: 10px;
			font-size: 15px;
			font-weight: 600;
			cursor: pointer;
			box-shadow: 0 8px 20px rgba(181, 137, 26, .32);
			transition: transform .2s ease, box-shadow .2s ease;
		}
		button.primary:hover { transform: translateY(-1px); box-shadow: 0 12px 24px rgba(181,137,26,.35); }
		button.secondary {
			border: 1px solid #d1d5db;
			background: white;
			color: #374151;
			padding: 10px 18px;
			border-radius: 10px;
			font-weight: 600;
			cursor: pointer;
		}
		.status-badge {
			display: inline-flex;
			align-items: center;
			gap: 6px;
			padding: 6px 12px;
			border-radius: 999px;
			font-size: 13px;
			font-weight: 600;
		}
		.status-success { background: #ecfdf5; color: #047857; }
		.status-error { background: #fef2f2; color: #b91c1c; }
		.status-pending { background: #fff8eb; color: #b45309; }
		.deal-card { border: 1px solid #e5e7eb; border-radius: 16px; padding: 20px; margin-bottom: 18px; background: white; box-shadow: 0 15px 24px rgba(17, 24, 39, .05); }
		.deal-header { display: flex; justify-content: space-between; align-items: center; gap: 12px; margin-bottom: 12px; }
		.deal-actions { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 14px; }
		.small-button {
			border: none;
			padding: 8px 12px;
			border-radius: 8px;
			font-size: 13px;
			cursor: pointer;
			font-weight: 600;
		}
		.btn-copy { background: #f3f4f6; color: #374151; }
		.btn-open { background: #2563eb; color: white; }
		.btn-danger { background: #ef4444; color: white; }
		.btn-outline { border: 1px solid #d1d5db; background: white; color: #374151; }
		.message { margin-top: 14px; padding: 12px 16px; border-radius: 10px; font-size: 14px; }
		.message.success { background: #ecfdf5; color: #047857; }
		.message.error { background: #fef2f2; color: #b91c1c; }
		.device-card, .account-card { border: 1px solid #e5e7eb; border-radius: 14px; padding: 18px; margin-bottom: 16px; background: white; box-shadow: 0 12px 22px rgba(17, 24, 39, .06); }
		.device-header { display: flex; justify-content: space-between; align-items: center; gap: 12px; margin-bottom: 8px; }
		.qr-area { margin-top: 12px; display: none; }
		.qr-area.active { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
		.qr-area pre { background: #1f2937; color: #f9fafb; padding: 12px; border-radius: 10px; font-size: 12px; max-width: 320px; overflow-x: auto; }
		.badge {
			padding: 4px 10px;
			border-radius: 8px;
			background: #f3f4f6;
			font-size: 12px;
			font-weight: 600;
			color: #374151;
		}
		.flex { display: flex; align-items: center; gap: 10px; }
		.flex-between { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
		.small-text { font-size: 13px; color: #6b7280; }
		.copy-target { font-family: 'Fira Code', monospace; font-size: 13px; }
		@media (max-width: 768px) {
			main { padding: 16px; }
			.tabs { flex-wrap: wrap; }
		}
	</style>
</head>
<body>
	<header>
		<h1>RTD PAY Platform</h1>
		<p>Управляйте устройствами, реквизитами и заявками для автоматического закрытия платежей.</p>
	</header>
	<main>
		<nav class="tabs">
			<button class="tab-button active" data-tab="deals">Заявки</button>
			<button class="tab-button" data-tab="devices">Устройства</button>
			<button class="tab-button" data-tab="accounts">Реквизиты</button>
			<button class="tab-button" data-tab="settings">Настройки</button>
		</nav>

		<section id="tab-deals" class="tab-content active">
			<div class="card">
				<h2 class="section-title">Создать заявку</h2>
				<div class="form-grid">
					<div>
						<label for="dealAmount">Сумма</label>
						<input type="text" id="dealAmount" placeholder="1234,56" />
					</div>
					<div>
						<label for="dealAccount">Реквизиты</label>
						<select id="dealAccount"></select>
					</div>
					<div>
						<label for="dealDevice">Устройство (опционально)</label>
						<select id="dealDevice"></select>
					</div>
				</div>
				<div style="margin-top: 18px; display:flex; gap:12px; flex-wrap: wrap;">
					<button class="primary" id="btnCreateDeal">Создать заявку</button>
					<div id="dealMessage"></div>
				</div>
			</div>

			<div class="card">
				<h2 class="section-title">Активные заявки</h2>
				<div id="dealsContainer">Загрузка...</div>
			</div>
		</section>

		<section id="tab-devices" class="tab-content">
			<div class="card">
				<h2 class="section-title">Добавить устройство</h2>
				<div class="form-grid">
					<div>
						<label for="deviceIdInput">ID устройства</label>
						<input type="text" id="deviceIdInput" placeholder="android-device-01" />
					</div>
					<div>
						<label for="deviceLabelInput">Название</label>
						<input type="text" id="deviceLabelInput" placeholder="Working phone" />
					</div>
					<div>
						<label for="deviceAccountSelect">Реквизиты (опц.)</label>
						<select id="deviceAccountSelect"></select>
					</div>
				</div>
				<div style="margin-top:18px; display:flex; gap:12px; align-items:center; flex-wrap: wrap;">
					<button class="primary" id="btnAddDevice">Сохранить устройство</button>
					<div id="deviceMessage"></div>
				</div>
			</div>

			<div class="card">
				<h2 class="section-title">Список устройств</h2>
				<div id="devicesContainer">Загрузка...</div>
			</div>
		</section>

		<section id="tab-accounts" class="tab-content">
			<div class="card">
				<h2 class="section-title">Добавить реквизиты</h2>
				<div class="form-grid">
					<div>
						<label for="accountName">Название</label>
						<input type="text" id="accountName" placeholder="ООО RTD / Владимир" />
					</div>
					<div>
						<label for="accountBank">Банк</label>
						<input type="text" id="accountBank" placeholder="МБанк" />
					</div>
					<div>
						<label for="accountNumber">Номер / карта</label>
						<input type="text" id="accountNumber" placeholder="40817810..." />
					</div>
				</div>
				<div style="margin-top:16px;">
					<label for="accountTemplate">Шаблон ссылки на оплату</label>
					<textarea id="accountTemplate" placeholder="https://mbank.example/pay?account={accountNumber}&amount={amount}&deal={dealId}"></textarea>
					<p class="small-text">Доступные плейсхолдеры: <code>{amount}</code>, <code>{dealId}</code>, <code>{accountNumber}</code>. Сумма автоматически заменяет запятую на точку.</p>
				</div>
				<div style="margin-top:18px; display:flex; gap:12px; align-items:center; flex-wrap: wrap;">
					<button class="primary" id="btnAddAccount">Сохранить реквизиты</button>
					<div id="accountMessage"></div>
				</div>
			</div>

			<div class="card">
				<h2 class="section-title">Сохранённые реквизиты</h2>
				<div id="accountsContainer">Пока нет реквизитов</div>
			</div>
		</section>

		<section id="tab-settings" class="tab-content">
			<div class="card">
				<h2 class="section-title">Подключение приложений</h2>
				<div class="flex-between">
					<div>
						<div class="small-text">Секрет для авторизации</div>
						<div id="configSecret" class="copy-target">—</div>
					</div>
					<button class="secondary" data-copy-target="configSecret">Скопировать</button>
				</div>
				<hr style="margin:20px 0;border:none;border-top:1px solid #e5e7eb;" />
				<div class="flex-between">
					<div>
						<div class="small-text">Endpoint для QR</div>
						<div id="configEndpoint" class="copy-target">—</div>
					</div>
					<button class="secondary" data-copy-target="configEndpoint">Скопировать</button>
				</div>
				<div style="margin-top:20px;" class="small-text">
					Автоотклонение заявок через <span id="configTimeout">15</span> минут.
				</div>
			</div>

			<div class="card">
				<h2 class="section-title">Инструкции</h2>
				<ol class="small-text" style="line-height:1.8;">
					<li>Создайте реквизиты на вкладке «Реквизиты», укажите шаблон ссылки М-банка.</li>
					<li>Создайте устройство и назначьте ему реквизиты. Сгенерируйте QR и отсканируйте его в приложении RTD automatic.</li>
					<li>После сканирования в приложении нажмите «Тест уведомление», чтобы устройство отметилось.</li>
					<li>Создайте заявку: выберите сумму, реквизит и устройство. Откройте ссылку на оплату, оплатите счёт.</li>
					<li>Как только придёт push с той же суммой, заявка подтвердится автоматически. Если нет — закроется через 15 минут.</li>
				</ol>
			</div>
		</section>
	</main>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" integrity="sha512-HkRbX8pDM6wHUwg2BCfVx2rdZ8raFMvx6bMpiKFFitvolSF/GpNZgbf+168Q5Q0SYJq0QAdzTZziM8r4xPp4Pw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script>
		const API_BASE = '/api'
		const state = {
			config: null,
			accounts: [],
			devices: [],
			deals: []
		}

		const tabButtons = document.querySelectorAll('.tab-button')
		tabButtons.forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)))

		function switchTab(tabId) {
			tabButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabId))
			document.querySelectorAll('.tab-content').forEach(section => {
				section.classList.toggle('active', section.id === `tab-${tabId}`)
			})
		}

		async function api(url, options = {}) {
			const res = await fetch(url, {
				headers: { 'Content-Type': 'application/json' },
				...options
			})
			const data = await res.json().catch(() => ({}))
			if (!res.ok) {
				throw new Error(data.error || 'Ошибка запроса')
			}
			return data
		}

		function setMessage(elementId, type, text) {
			const el = document.getElementById(elementId)
			if (!el) return
			if (!text) {
				el.innerHTML = ''
				return
			}
			el.innerHTML = `<div class="message ${type}">${text}</div>`
		}

		async function loadConfig() {
			const data = await api(`${API_BASE}/config`)
			state.config = data
			document.getElementById('configSecret').textContent = data.secret
			document.getElementById('configEndpoint').textContent = data.endpoint
			document.getElementById('configTimeout').textContent = data.autoRejectMinutes
		}

		async function loadAccounts() {
			const data = await api(`${API_BASE}/accounts`)
			state.accounts = data.accounts || []
			renderAccounts()
			populateAccountSelects()
		}

		async function loadDevices() {
			const data = await api(`${API_BASE}/devices`)
			state.devices = data.devices || []
			renderDevices()
			populateDeviceSelects()
		}

		async function loadDeals() {
			const data = await api(`${API_BASE}/deals`)
			state.deals = data.deals || []
			renderDeals()
		}

		function populateAccountSelects() {
			const dealSelect = document.getElementById('dealAccount')
			const deviceSelect = document.getElementById('deviceAccountSelect')
			const accountOptions = state.accounts.map(account => `<option value="${account.id}">${account.label}</option>`)
			dealSelect.innerHTML = '<option value="">Выберите реквизиты</option>' + accountOptions.join('')
			deviceSelect.innerHTML = '<option value="">Без реквизитов</option>' + accountOptions.join('')
		}

		function populateDeviceSelects() {
			const dealDevice = document.getElementById('dealDevice')
			const options = state.devices.map(device => {
				const status = device.status === 'active' ? 'активен' : 'ожидает'
				return `<option value="${device.id}">${device.label || device.id} (${status})</option>`
			})
			dealDevice.innerHTML = '<option value="">Без устройства</option>' + options.join('')
		}

		function renderAccounts() {
			const container = document.getElementById('accountsContainer')
			if (!state.accounts.length) {
				container.innerHTML = '<p class="small-text">Реквизитов пока нет.</p>'
				return
			}
			container.innerHTML = state.accounts.map(account => `
				<div class="account-card">
					<div class="flex-between">
						<strong>${account.label}</strong>
						<span class="badge">ID ${account.id}</span>
					</div>
					<p class="small-text">Банк: ${account.bank || '—'} · Номер: ${account.number || '—'}</p>
					<p class="small-text">Шаблон: <code>${account.paymentTemplate}</code></p>
				</div>
			`).join('')
		}

		function renderDevices() {
			const container = document.getElementById('devicesContainer')
			if (!state.devices.length) {
				container.innerHTML = '<p class="small-text">Устройств пока нет.</p>'
				return
			}
			container.innerHTML = state.devices.map(device => {
				const accountLabel = device.accountLabel || 'Не назначено'
				const statusLabel = device.status === 'active' ? 'Активирован' : 'Ожидает активации'
				const statusClass = device.status === 'active' ? 'status-success' : 'status-pending'
				const lastSeen = device.lastSeen ? new Date(device.lastSeen).toLocaleString('ru-RU') : '—'
				const selectOptions = ['<option value="">Без реквизитов</option>'].concat(state.accounts.map(account => `<option value="${account.id}" ${account.id === device.accountId ? 'selected' : ''}>${account.label}</option>`))
				return `
					<div class="device-card" data-device="${device.id}">
						<div class="device-header">
							<div>
								<strong>${device.label || device.id}</strong>
								<div class="small-text">ID: ${device.id}</div>
							</div>
							<span class="status-badge ${statusClass}">${statusLabel}</span>
						</div>
						<p class="small-text">Реквизиты: <strong>${accountLabel}</strong></p>
						<p class="small-text">Последняя активность: ${lastSeen}</p>
						<div class="form-grid" style="margin-top:12px;">
							<div>
								<label>Назначить реквизиты</label>
								<select class="device-account-select">${selectOptions.join('')}</select>
							</div>
						</div>
						<div class="deal-actions">
							<button class="small-button btn-open" data-action="assign">Назначить</button>
							<button class="small-button btn-outline" data-action="activate">Пометить активным</button>
							<button class="small-button btn-copy" data-action="qr">Сгенерировать QR</button>
						</div>
						<div class="qr-area" id="qr-${device.id}">
							<div class="qr-holder"></div>
							<pre></pre>
						</div>
					</div>
				`
			}).join('')

			container.querySelectorAll('.device-card').forEach(card => {
				const deviceId = card.dataset.device
				card.querySelectorAll('[data-action]').forEach(button => {
					button.addEventListener('click', () => handleDeviceAction(deviceId, button.dataset.action, card))
				})
			})
		}

		async function handleDeviceAction(deviceId, action, card) {
			try {
				if (action === 'assign') {
					const select = card.querySelector('.device-account-select')
					const accountId = select.value
					await api(`${API_BASE}/device/${deviceId}/account`, {
						method: 'POST',
						body: JSON.stringify({ accountId })
					})
					await loadDevices()
					return
				}
				if (action === 'activate') {
					await api(`${API_BASE}/device/${deviceId}/activate`, { method: 'POST', body: JSON.stringify({}) })
					await loadDevices()
					return
				}
				if (action === 'qr') {
					const device = state.devices.find(d => d.id === deviceId)
					if (!device) throw new Error('Устройство не найдено')
					if (!device.accountLabel) {
						throw new Error('Назначьте реквизиты перед генерацией QR')
					}
					const payload = {
						endpoint: state.config?.endpoint || `${window.location.origin}/notify`,
						secret: state.config?.secret,
						deviceId: device.id,
						account: device.accountLabel
					}
					const qrArea = document.getElementById(`qr-${deviceId}`)
					const holder = qrArea.querySelector('.qr-holder')
					holder.innerHTML = ''
					new QRCode(holder, {
						text: JSON.stringify(payload),
						width: 180,
						height: 180,
						colorDark: '#1f2937',
						colorLight: '#ffffff'
					})
					qrArea.querySelector('pre').textContent = JSON.stringify(payload, null, 2)
					qrArea.classList.add('active')
				}
			} catch (err) {
				alert(err.message)
			}
		}

		function renderDeals() {
			const container = document.getElementById('dealsContainer')
			if (!state.deals.length) {
				container.innerHTML = '<p class="small-text">Заявок пока нет.</p>'
				return
			}

			const autoRejectMs = (state.config?.autoRejectMinutes || 15) * 60 * 1000
			container.innerHTML = state.deals.map(deal => {
				const createdAt = new Date(deal.createdAt)
				const expiresAt = new Date(createdAt.getTime() + autoRejectMs)
				const timeLeftMs = expiresAt - Date.now()
				let timeLeft = ''
				if (deal.status === 'pending' && timeLeftMs > 0) {
					const minutes = Math.floor(timeLeftMs / 60000)
					const seconds = Math.floor((timeLeftMs % 60000) / 1000)
					timeLeft = `${minutes}:${seconds.toString().padStart(2, '0')}`
				}
				const statusClass = deal.statusColor === 'success' ? 'status-success' : deal.statusColor === 'error' ? 'status-error' : 'status-pending'
				const statusLabel = deal.statusLabel || 'Ожидание'
				const paymentLinkHtml = deal.paymentLink ? `<button class="small-button btn-open" data-open="${deal.paymentLink}">Открыть оплату</button>` : ''
				const copyLinkHtml = deal.paymentLink ? `<button class="small-button btn-copy" data-copy="${deal.paymentLink}">Скопировать ссылку</button>` : ''
				const matchInfo = deal.match ? `<p class="small-text">Подтверждено уведомлением: ${deal.match.title || '—'}</p>` : ''
				return `
					<div class="deal-card" data-deal="${deal.id}">
						<div class="deal-header">
							<div>
								<strong>#${deal.id}</strong>
								<div class="small-text">Создано: ${createdAt.toLocaleString('ru-RU')}</div>
							</div>
							<span class="status-badge ${statusClass}">${statusLabel}</span>
						</div>
						<p class="small-text"><strong>Сумма:</strong> ${deal.amount} · <strong>Реквизиты:</strong> ${deal.accountLabel || '—'}</p>
						<p class="small-text"><strong>Устройство:</strong> ${deal.deviceLabel || deal.deviceId || 'не указано'}</p>
						${deal.paymentLink ? `<p class="small-text">Ссылка на оплату: <code>${deal.paymentLink}</code></p>` : ''}
						${matchInfo}
						${deal.status === 'pending' && timeLeft ? `<p class="small-text">⏱ До таймаута: ${timeLeft}</p>` : ''}
						<div class="deal-actions">
							${paymentLinkHtml}
							${copyLinkHtml}
							${deal.status === 'pending' ? `<button class="small-button btn-open" data-action="close">Подтвердить</button>` : ''}
							${deal.status === 'pending' ? `<button class="small-button btn-danger" data-action="reject">Отклонить</button>` : ''}
						</div>
					</div>
				`
			}).join('')

			container.querySelectorAll('[data-open]').forEach(btn => {
				btn.addEventListener('click', () => window.open(btn.dataset.open, '_blank'))
			})
			container.querySelectorAll('[data-copy]').forEach(btn => {
				btn.addEventListener('click', () => copyText(btn.dataset.copy))
			})
			container.querySelectorAll('.deal-card').forEach(card => {
				const dealId = card.dataset.deal
				card.querySelectorAll('[data-action]').forEach(button => {
					button.addEventListener('click', () => handleDealAction(dealId, button.dataset.action))
				})
			})
		}

		async function handleDealAction(dealId, action) {
			try {
				if (action === 'close') {
					await api(`${API_BASE}/deal/${dealId}/close`, { method: 'POST', body: JSON.stringify({}) })
				} else if (action === 'reject') {
					await api(`${API_BASE}/deal/${dealId}/reject`, { method: 'POST', body: JSON.stringify({ reason: 'manual' }) })
				}
				await loadDeals()
			} catch (err) {
				alert(err.message)
			}
		}

		async function createDeal() {
			try {
				const amount = document.getElementById('dealAmount').value.trim()
				const accountId = document.getElementById('dealAccount').value
				const deviceId = document.getElementById('dealDevice').value
				if (!amount) throw new Error('Введите сумму')
				if (!accountId) throw new Error('Выберите реквизиты')
				const payload = { amount, accountId, deviceId }
				await api(`${API_BASE}/deal`, {
					method: 'POST',
					body: JSON.stringify(payload)
				})
				setMessage('dealMessage', 'success', 'Заявка создана')
				document.getElementById('dealAmount').value = ''
				await loadDeals()
			} catch (err) {
				setMessage('dealMessage', 'error', err.message)
			}
		}

		async function addDevice() {
			try {
				const id = document.getElementById('deviceIdInput').value.trim()
				const label = document.getElementById('deviceLabelInput').value.trim()
				const accountId = document.getElementById('deviceAccountSelect').value
				if (!id) throw new Error('Введите ID устройства')
				await api(`${API_BASE}/device`, {
					method: 'POST',
					body: JSON.stringify({ deviceId: id, label, accountId })
				})
				setMessage('deviceMessage', 'success', 'Устройство сохранено')
				document.getElementById('deviceIdInput').value = ''
				document.getElementById('deviceLabelInput').value = ''
				document.getElementById('deviceAccountSelect').value = ''
				await loadDevices()
			} catch (err) {
				setMessage('deviceMessage', 'error', err.message)
			}
		}

		async function addAccount() {
			try {
				const name = document.getElementById('accountName').value.trim()
				const bank = document.getElementById('accountBank').value.trim()
				const number = document.getElementById('accountNumber').value.trim()
				const paymentTemplate = document.getElementById('accountTemplate').value.trim()
				await api(`${API_BASE}/account`, {
					method: 'POST',
					body: JSON.stringify({ name, bank, number, paymentTemplate })
				})
				setMessage('accountMessage', 'success', 'Реквизиты сохранены')
				document.getElementById('accountName').value = ''
				document.getElementById('accountBank').value = ''
				document.getElementById('accountNumber').value = ''
				document.getElementById('accountTemplate').value = ''
				await loadAccounts()
			} catch (err) {
				setMessage('accountMessage', 'error', err.message)
			}
		}

		function copyText(text) {
			navigator.clipboard.writeText(text).then(() => {
				alert('Скопировано в буфер обмена')
			}).catch(() => alert('Не удалось скопировать'))
		}

		document.getElementById('btnCreateDeal').addEventListener('click', createDeal)
		document.getElementById('btnAddDevice').addEventListener('click', addDevice)
		document.getElementById('btnAddAccount').addEventListener('click', addAccount)
		document.querySelectorAll('[data-copy-target]').forEach(btn => {
			btn.addEventListener('click', () => {
				const targetId = btn.getAttribute('data-copy-target')
				const value = document.getElementById(targetId)?.textContent
				if (value) copyText(value)
			})
		})

		async function init() {
			try {
				await loadConfig()
				await loadAccounts()
				await loadDevices()
				await loadDeals()
				setInterval(() => {
					loadDeals()
					loadDevices()
				}, 7000)
			} catch (err) {
				console.error(err)
				alert('Ошибка загрузки платформы: ' + err.message)
			}
		}

		init()
	</script>
</body>
</html>

