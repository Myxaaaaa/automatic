<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –∑–∞—è–≤–æ–∫</title>
	<style>
		* { margin: 0; padding: 0; box-sizing: border-box; }
		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
			background: #f5f5f5;
			padding: 20px;
			max-width: 1200px;
			margin: 0 auto;
		}
		header {
			background: #1976d2;
			color: white;
			padding: 20px;
			border-radius: 8px;
			margin-bottom: 20px;
		}
		header h1 { font-size: 24px; }
		.form-section {
			background: white;
			padding: 20px;
			border-radius: 8px;
			margin-bottom: 20px;
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
		}
		.form-section h2 { margin-bottom: 15px; color: #333; }
		.form-group {
			margin-bottom: 15px;
		}
		label {
			display: block;
			margin-bottom: 5px;
			font-weight: 500;
			color: #555;
		}
		input[type="text"] {
			width: 100%;
			padding: 10px;
			border: 1px solid #ddd;
			border-radius: 4px;
			font-size: 16px;
		}
		button {
			padding: 10px 20px;
			border: none;
			border-radius: 4px;
			font-size: 16px;
			cursor: pointer;
			transition: background 0.2s;
		}
		.btn-primary {
			background: #1976d2;
			color: white;
		}
		.btn-primary:hover { background: #1565c0; }
		.btn-success {
			background: #4caf50;
			color: white;
		}
		.btn-success:hover { background: #45a049; }
		.btn-danger {
			background: #f44336;
			color: white;
		}
		.btn-danger:hover { background: #da190b; }
		.btn-small {
			padding: 5px 10px;
			font-size: 14px;
			margin-left: 5px;
		}
		.deals-list {
			background: white;
			padding: 20px;
			border-radius: 8px;
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
		}
		.deal-item {
			border: 1px solid #ddd;
			border-radius: 4px;
			padding: 15px;
			margin-bottom: 10px;
			position: relative;
		}
		.deal-item.pending {
			border-left: 4px solid #ff9800;
		}
		.deal-item.confirmed {
			border-left: 4px solid #4caf50;
		}
		.deal-item.rejected {
			border-left: 4px solid #f44336;
		}
		.deal-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 10px;
		}
		.deal-id {
			font-weight: bold;
			color: #666;
		}
		.status-badge {
			padding: 4px 8px;
			border-radius: 4px;
			font-size: 12px;
			font-weight: bold;
			text-transform: uppercase;
		}
		.status-pending { background: #fff3e0; color: #e65100; }
		.status-confirmed { background: #e8f5e9; color: #2e7d32; }
		.status-rejected { background: #ffebee; color: #c62828; }
		.deal-amount {
			font-size: 20px;
			font-weight: bold;
			color: #333;
			margin: 10px 0;
		}
		.deal-meta {
			font-size: 12px;
			color: #999;
			margin-top: 5px;
		}
		.deal-actions {
			margin-top: 10px;
		}
		.timer {
			font-weight: bold;
			color: #ff9800;
		}
		.error {
			background: #ffebee;
			color: #c62828;
			padding: 10px;
			border-radius: 4px;
			margin-top: 10px;
		}
		.success {
			background: #e8f5e9;
			color: #2e7d32;
			padding: 10px;
			border-radius: 4px;
			margin-top: 10px;
		}
	</style>
</head>
<body>
	<header>
		<h1>üí∞ –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –∑–∞—è–≤–æ–∫ –Ω–∞ –≤—Ö–æ–¥—è—â–∏–µ –¥–µ–Ω—å–≥–∏</h1>
	</header>

	<div class="form-section">
		<h2>–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</h2>
		<div class="form-group">
			<label for="amount">–°—É–º–º–∞:</label>
			<input type="text" id="amount" placeholder="1234,56" />
		</div>
		<div class="form-group">
			<label for="deviceSelect">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
			<select id="deviceSelect"></select>
		</div>
		<div class="form-group">
			<label for="accountInput">–†–µ–∫–≤–∏–∑–∏—Ç—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
			<input type="text" id="accountInput" placeholder="–ö–∞—Ä—Ç–∞ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 1234" />
			<small id="deviceInfo" style="display:block;margin-top:4px;color:#777;"></small>
		</div>
		<button class="btn-primary" onclick="createDeal()">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
		<div id="createMessage"></div>
	</div>

	<div class="form-section">
		<h2>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</h2>
		<div id="devicesContainer">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
		<hr style="margin:15px 0;">
		<h3 style="margin-bottom:10px;">–î–æ–±–∞–≤–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤—Ä—É—á–Ω—É—é</h3>
		<div class="form-group">
			<label for="deviceIdInput">Device ID:</label>
			<input type="text" id="deviceIdInput" placeholder="android-device-01" />
		</div>
		<div class="form-group">
			<label for="deviceAccountInput">–†–µ–∫–≤–∏–∑–∏—Ç—ã (–æ–ø—Ü.):</label>
			<input type="text" id="deviceAccountInput" placeholder="–ö–∞—Ä—Ç–∞ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 1234" />
		</div>
		<button class="btn-success" onclick="addDevice()">–î–æ–±–∞–≤–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</button>
		<div id="deviceMessage"></div>
	</div>

	<div class="deals-list">
		<h2>–ó–∞—è–≤–∫–∏</h2>
		<div id="dealsContainer">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
	</div>

	<script>
		const API_BASE = '/api'
		let devicesCache = []

		function formatDate(value) {
			return value ? new Date(value).toLocaleString('ru-RU') : ''
		}

		function getDeviceById(id) {
			return devicesCache.find(d => d.id === id)
		}

		// Create deal
		async function createDeal() {
			const amount = document.getElementById('amount').value.trim()
			const deviceId = document.getElementById('deviceSelect').value
			const account = document.getElementById('accountInput').value.trim()
			const msgEl = document.getElementById('createMessage')
			if (!amount) {
				msgEl.innerHTML = '<div class="error">–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É</div>'
				return
			}
			const payload = { amount }
			if (deviceId) payload.deviceId = deviceId
			if (account) payload.account = account
			try {
				const res = await fetch(`${API_BASE}/deal`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(payload)
				})
				const data = await res.json()
				if (res.ok) {
					msgEl.innerHTML = '<div class="success">–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!</div>'
					document.getElementById('amount').value = ''
					if (!payload.account) document.getElementById('accountInput').value = ''
					loadDeals()
				} else {
					msgEl.innerHTML = `<div class="error">–û—à–∏–±–∫–∞: ${data.error}</div>`
				}
			} catch (err) {
				msgEl.innerHTML = `<div class="error">–û—à–∏–±–∫–∞: ${err.message}</div>`
			}
		}

		async function addDevice() {
			const deviceId = document.getElementById('deviceIdInput').value.trim()
			const account = document.getElementById('deviceAccountInput').value.trim()
			const msgEl = document.getElementById('deviceMessage')
			if (!deviceId) {
				msgEl.innerHTML = '<div class="error">–í–≤–µ–¥–∏—Ç–µ deviceId</div>'
				return
			}
			try {
				const res = await fetch(`${API_BASE}/device`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ deviceId, account })
				})
				const data = await res.json()
				if (res.ok) {
					msgEl.innerHTML = '<div class="success">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ</div>'
					document.getElementById('deviceIdInput').value = ''
					document.getElementById('deviceAccountInput').value = ''
					loadDevices()
				} else {
					msgEl.innerHTML = `<div class="error">–û—à–∏–±–∫–∞: ${data.error}</div>`
				}
			} catch (err) {
				msgEl.innerHTML = `<div class="error">–û—à–∏–±–∫–∞: ${err.message}</div>`
			}
		}

		// Close deal
		async function closeDeal(id) {
			try {
				const res = await fetch(`${API_BASE}/deal/${id}/close`, { method: 'POST' })
				const data = await res.json()
				if (res.ok) {
					loadDeals()
				} else {
					alert(`–û—à–∏–±–∫–∞: ${data.error}`)
				}
			} catch (err) {
				alert(`–û—à–∏–±–∫–∞: ${err.message}`)
			}
		}

		// Reject deal
		async function rejectDeal(id) {
			if (!confirm('–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É?')) return
			try {
				const res = await fetch(`${API_BASE}/deal/${id}/reject`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ reason: 'manual' })
				})
				const data = await res.json()
				if (res.ok) {
					loadDeals()
				} else {
					alert(`–û—à–∏–±–∫–∞: ${data.error}`)
				}
			} catch (err) {
				alert(`–û—à–∏–±–∫–∞: ${err.message}`)
			}
		}

		// Load deals
		async function loadDeals() {
			try {
				const res = await fetch(`${API_BASE}/deals`)
				const data = await res.json()
				if (res.ok) {
					renderDeals(data.deals || [])
				}
			} catch (err) {
				document.getElementById('dealsContainer').innerHTML = `<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err.message}</div>`
			}
		}

		async function loadDevices() {
			try {
				const res = await fetch(`${API_BASE}/devices`)
				const data = await res.json()
				if (res.ok) {
					devicesCache = data.devices || []
					renderDevices(devicesCache)
					populateDeviceSelect(devicesCache)
				}
			} catch (err) {
				document.getElementById('devicesContainer').innerHTML = `<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err.message}</div>`
			}
		}

		function populateDeviceSelect(devices) {
			const select = document.getElementById('deviceSelect')
			const current = select.value
			select.innerHTML = '<option value="">–õ—é–±–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</option>'
			devices.forEach(device => {
				const option = document.createElement('option')
				option.value = device.id
				option.textContent = `${device.id}${device.account ? ` (${device.account})` : ''}`
				select.appendChild(option)
			})
			if (current) {
				select.value = current
				if (select.value !== current) select.value = ''
			}
			handleDeviceSelectChange()
		}

		function renderDevices(devices) {
			const container = document.getElementById('devicesContainer')
			if (devices.length === 0) {
				container.innerHTML = '<p>–£—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –≤—Ä—É—á–Ω—É—é.</p>'
				return
			}
			devices.sort((a, b) => {
				return new Date(b.lastSeen || b.registeredAt) - new Date(a.lastSeen || a.registeredAt)
			})
			container.innerHTML = devices.map(device => {
				const lastSeen = formatDate(device.lastSeen)
				const registeredAt = formatDate(device.registeredAt)
				return `
					<div class="deal-item">
						<div class="deal-header">
							<span class="deal-id">ID: ${device.id}</span>
							<span class="status-badge status-pending">${device.source || 'device'}</span>
						</div>
						<div class="deal-meta">–†–µ–∫–≤–∏–∑–∏—Ç—ã: ${device.account || '‚Äî'}</div>
						<div class="deal-meta">–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${lastSeen || '‚Äî'}</div>
						<div class="deal-meta">–î–æ–±–∞–≤–ª–µ–Ω–æ: ${registeredAt || '‚Äî'}</div>
					</div>
				`
			}).join('')
		}

		function handleDeviceSelectChange() {
			const select = document.getElementById('deviceSelect')
			const info = document.getElementById('deviceInfo')
			const accountInput = document.getElementById('accountInput')
			const device = getDeviceById(select.value)
			if (device) {
				info.textContent = device.account ? `–†–µ–∫–≤–∏–∑–∏—Ç—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: ${device.account}` : '–†–µ–∫–≤–∏–∑–∏—Ç—ã –Ω–µ –∑–∞–¥–∞–Ω—ã'
				if (!accountInput.value && device.account) {
					accountInput.value = device.account
				}
			} else {
				info.textContent = '–ï—Å–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ–ª—è –ø—É—Å—Ç—ã–º–∏, –∑–∞—è–≤–∫–∞ –∑–∞–∫—Ä–æ–µ—Ç—Å—è –ø–æ —Å—É–º–º–µ —Å –ª—é–±–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.'
			}
		}

		// Render deals
		function renderDeals(deals) {
			const container = document.getElementById('dealsContainer')
			if (deals.length === 0) {
				container.innerHTML = '<p>–ó–∞—è–≤–æ–∫ –Ω–µ—Ç</p>'
				return
			}
			// Sort: pending first, then by date desc
			deals.sort((a, b) => {
				if (a.status === 'pending' && b.status !== 'pending') return -1
				if (a.status !== 'pending' && b.status === 'pending') return 1
				return new Date(b.createdAt) - new Date(a.createdAt)
			})
			container.innerHTML = deals.map(deal => {
				const createdAt = formatDate(deal.createdAt)
				const timeLeft = deal.status === 'pending' ? getTimeLeft(deal.createdAt) : null
				let matchInfo = ''
				if (deal.match) {
					matchInfo = `<div class="deal-meta">‚úÖ –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ: ${deal.match.title || 'N/A'} (${deal.match.deviceId || 'device ?'})</div>`
				}
				let actions = ''
				if (deal.status === 'pending') {
					actions = `
						<div class="deal-actions">
							<button class="btn-success btn-small" onclick="closeDeal('${deal.id}')">–ó–∞–∫—Ä—ã—Ç—å</button>
							<button class="btn-danger btn-small" onclick="rejectDeal('${deal.id}')">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
							${timeLeft ? `<span class="timer">‚è± –û—Å—Ç–∞–ª–æ—Å—å: ${timeLeft}</span>` : ''}
						</div>
					`
				}
				return `
					<div class="deal-item ${deal.status}">
						<div class="deal-header">
							<span class="deal-id">#${deal.id}</span>
							<span class="status-badge status-${deal.status}">${getStatusText(deal.status)}</span>
						</div>
						<div class="deal-amount">${deal.amount}</div>
						<div class="deal-meta">–°–æ–∑–¥–∞–Ω–æ: ${createdAt}</div>
						${deal.deviceId ? `<div class="deal-meta">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${deal.deviceId}</div>` : ''}
						${deal.account ? `<div class="deal-meta">–†–µ–∫–≤–∏–∑–∏—Ç—ã: ${deal.account}</div>` : ''}
						${deal.confirmedAt ? `<div class="deal-meta">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ: ${formatDate(deal.confirmedAt)}</div>` : ''}
						${deal.rejectedAt ? `<div class="deal-meta">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ: ${formatDate(deal.rejectedAt)} (${deal.reason || 'manual'})</div>` : ''}
						${matchInfo}
						${actions}
					</div>
				`
			}).join('')
		}

		// Get status text
		function getStatusText(status) {
			const map = {
				pending: '–û–∂–∏–¥–∞–Ω–∏–µ',
				confirmed: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ',
				rejected: '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ'
			}
			return map[status] || status
		}

		// Get time left until auto-reject (15 minutes)
		function getTimeLeft(createdAt) {
			const created = new Date(createdAt)
			const now = new Date()
			const elapsed = now - created
			const total = 15 * 60 * 1000
			const left = total - elapsed
			if (left <= 0) return '0:00'
			const minutes = Math.floor(left / 60000)
			const seconds = Math.floor((left % 60000) / 1000)
			return `${minutes}:${seconds.toString().padStart(2, '0')}`
		}

		// Auto-refresh every 5 seconds
		setInterval(() => {
			loadDeals()
			loadDevices()
		}, 5000)
		// Initial load
		loadDeals()
		loadDevices()

		document.getElementById('deviceSelect').addEventListener('change', handleDeviceSelectChange)
		// Enter key to create deal
		document.getElementById('amount').addEventListener('keypress', (e) => {
			if (e.key === 'Enter') createDeal()
		})
	</script>
</body>
</html>

