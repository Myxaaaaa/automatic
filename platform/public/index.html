<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>RTD Platform</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
	<style>
		* { box-sizing: border-box; }
		body {
			margin: 0;
			font-family: 'Inter', sans-serif;
			background: #f3f4f6;
			color: #1f2937;
		}
		a { color: #b5891a; }
		header {
			background: linear-gradient(135deg, #d4af37, #b5891a);
			color: white;
			padding: 24px 32px 18px;
			box-shadow: 0 6px 20px rgba(212, 175, 55, 0.35);
		}
		header h1 {
			margin: 0;
			font-size: 28px;
			font-weight: 700;
		}
		header p {
			margin: 6px 0 0;
			font-size: 15px;
			opacity: 0.9;
		}
		main {
			padding: 16px 32px 48px;
			max-width: 1200px;
			margin: 0 auto;
		}
		.tabs {
			display: flex;
			gap: 16px;
			margin: 24px 0;
		}
		.tab-button {
			border: none;
			background: white;
			padding: 12px 20px;
			border-radius: 12px;
			font-size: 15px;
			cursor: pointer;
			box-shadow: 0 10px 20px rgba(0,0,0,0.08);
			font-weight: 600;
			color: #4b5563;
			transition: transform .2s ease, box-shadow .2s ease, background .2s ease;
		}
		.tab-button.active {
			background: linear-gradient(135deg, #d4af37, #b5891a);
			color: white;
			transform: translateY(-2px);
			box-shadow: 0 12px 24px rgba(181, 137, 26, .35);
		}
		.tab-content { display: none; }
		.tab-content.active { display: block; }
		.card {
			background: white;
			border-radius: 14px;
			box-shadow: 0 18px 30px rgba(23,37,84,.08);
			margin-bottom: 24px;
			padding: 24px;
		}
		.section-title {
			font-size: 18px;
			font-weight: 700;
			margin-bottom: 16px;
			color: #111827;
		}
		.form-grid {
			display: grid;
			gap: 16px;
			grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
		}
		label {
			display: block;
			font-size: 13px;
			font-weight: 600;
			color: #6b7280;
			margin-bottom: 6px;
		}
		input, select, textarea {
			width: 100%;
			padding: 12px 14px;
			border-radius: 10px;
			border: 1px solid #d1d5db;
			font-size: 15px;
			background: #f9fafb;
			transition: border .2s ease, box-shadow .2s ease;
		}
		input:focus, select:focus, textarea:focus {
			outline: none;
			border-color: #d4af37;
			box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.25);
		}
		textarea { resize: vertical; min-height: 90px; }
		button.primary {
			border: none;
			background: linear-gradient(135deg, #d4af37, #b5891a);
			color: white;
			padding: 12px 24px;
			border-radius: 10px;
			font-size: 15px;
			font-weight: 600;
			cursor: pointer;
			box-shadow: 0 8px 20px rgba(181, 137, 26, .32);
			transition: transform .2s ease, box-shadow .2s ease;
		}
		button.primary:hover { transform: translateY(-1px); box-shadow: 0 12px 24px rgba(181,137,26,.35); }
		button.secondary {
			border: 1px solid #d1d5db;
			background: white;
			color: #374151;
			padding: 10px 18px;
			border-radius: 10px;
			font-weight: 600;
			cursor: pointer;
		}
		.status-badge {
			display: inline-flex;
			align-items: center;
			gap: 6px;
			padding: 6px 12px;
			border-radius: 999px;
			font-size: 13px;
			font-weight: 600;
		}
		.status-success { background: #ecfdf5; color: #047857; }
		.status-error { background: #fef2f2; color: #b91c1c; }
		.status-pending { background: #fff8eb; color: #b45309; }
		.deal-card { border: 1px solid #e5e7eb; border-radius: 16px; padding: 20px; margin-bottom: 18px; background: white; box-shadow: 0 15px 24px rgba(17, 24, 39, .05); }
		.deal-header { display: flex; justify-content: space-between; align-items: center; gap: 12px; margin-bottom: 12px; }
		.deal-actions { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 14px; }
		.small-button {
			border: none;
			padding: 8px 12px;
			border-radius: 8px;
			font-size: 13px;
			cursor: pointer;
			font-weight: 600;
		}
		.btn-copy { background: #f3f4f6; color: #374151; }
		.btn-open { background: #2563eb; color: white; }
		.btn-danger { background: #ef4444; color: white; }
		.btn-outline { border: 1px solid #d1d5db; background: white; color: #374151; }
		.message { margin-top: 14px; padding: 12px 16px; border-radius: 10px; font-size: 14px; }
		.message.success { background: #ecfdf5; color: #047857; }
		.message.error { background: #fef2f2; color: #b91c1c; }
		.device-card, .account-card { border: 1px solid #e5e7eb; border-radius: 14px; padding: 18px; margin-bottom: 16px; background: white; box-shadow: 0 12px 22px rgba(17, 24, 39, .06); }
		.device-header { display: flex; justify-content: space-between; align-items: center; gap: 12px; margin-bottom: 8px; }
		.qr-area { margin-top: 12px; display: none; }
		.qr-area.active { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
		.qr-area pre { background: #1f2937; color: #f9fafb; padding: 12px; border-radius: 10px; font-size: 12px; max-width: 320px; overflow-x: auto; }
		.badge {
			padding: 4px 10px;
			border-radius: 8px;
			background: #f3f4f6;
			font-size: 12px;
			font-weight: 600;
			color: #374151;
		}
		.flex { display: flex; align-items: center; gap: 10px; }
		.flex-between { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
		.small-text { font-size: 13px; color: #6b7280; }
		.copy-target { font-family: 'Fira Code', monospace; font-size: 13px; }
		@media (max-width: 768px) {
			main { padding: 16px; }
			.tabs { flex-wrap: wrap; }
		}
	</style>
</head>
<body>
	<header>
		<h1>RTD PAY Platform</h1>
		<p>–£–ø—Ä–∞–≤–ª—è–π—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏, —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º–∏ –∏ –∑–∞—è–≤–∫–∞–º–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–ª–∞—Ç–µ–∂–µ–π.</p>
	</header>
	<main>
		<nav class="tabs">
			<button class="tab-button active" data-tab="deals">–ó–∞—è–≤–∫–∏</button>
			<button class="tab-button" data-tab="devices">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</button>
			<button class="tab-button" data-tab="accounts">–†–µ–∫–≤–∏–∑–∏—Ç—ã</button>
			<button class="tab-button" data-tab="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
		</nav>

		<section id="tab-deals" class="tab-content active">
			<div class="card">
				<h2 class="section-title">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</h2>
				<div class="form-grid">
					<div>
						<label for="dealAmount">–°—É–º–º–∞</label>
						<input type="text" id="dealAmount" placeholder="1234,56" />
					</div>
					<div>
						<label for="dealAccount">–†–µ–∫–≤–∏–∑–∏—Ç—ã</label>
						<select id="dealAccount"></select>
					</div>
					<div>
						<label for="dealDevice">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
						<select id="dealDevice"></select>
					</div>
				</div>
				<div style="margin-top: 18px; display:flex; gap:12px; flex-wrap: wrap;">
					<button class="primary" id="btnCreateDeal">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
					<div id="dealMessage"></div>
				</div>
			</div>

			<div class="card">
				<h2 class="section-title">–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞—è–≤–∫–∏</h2>
				<div id="dealsContainer">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
			</div>
		</section>

		<section id="tab-devices" class="tab-content">
			<div class="card">
				<h2 class="section-title">–î–æ–±–∞–≤–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</h2>
				<div class="form-grid">
					<div>
						<label for="deviceIdInput">ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</label>
						<input type="text" id="deviceIdInput" placeholder="android-device-01" />
					</div>
					<div>
						<label for="deviceLabelInput">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
						<input type="text" id="deviceLabelInput" placeholder="Working phone" />
					</div>
					<div>
						<label for="deviceAccountSelect">–†–µ–∫–≤–∏–∑–∏—Ç—ã (–æ–ø—Ü.)</label>
						<select id="deviceAccountSelect"></select>
					</div>
				</div>
				<div style="margin-top:18px; display:flex; gap:12px; align-items:center; flex-wrap: wrap;">
					<button class="primary" id="btnAddDevice">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</button>
					<div id="deviceMessage"></div>
				</div>
			</div>

			<div class="card">
				<h2 class="section-title">–°–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤</h2>
				<div id="devicesContainer">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
			</div>
		</section>

		<section id="tab-accounts" class="tab-content">
			<div class="card">
				<h2 class="section-title">–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</h2>
				<div class="form-grid">
					<div>
						<label for="accountName">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
						<input type="text" id="accountName" placeholder="–û–û–û RTD / –í–ª–∞–¥–∏–º–∏—Ä" />
					</div>
					<div>
						<label for="accountBank">–ë–∞–Ω–∫</label>
						<input type="text" id="accountBank" placeholder="–ú–ë–∞–Ω–∫" />
					</div>
					<div>
						<label for="accountNumber">–ù–æ–º–µ—Ä / –∫–∞—Ä—Ç–∞</label>
						<input type="text" id="accountNumber" placeholder="40817810..." />
					</div>
				</div>
				<p class="small-text" style="margin-top:12px;">–®–∞–±–ª–æ–Ω —Å—Å—ã–ª–∫–∏ –¥–ª—è –ú-–ë–∞–Ω–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏: <code>mbank://transfer?amount={amount}&to={accountNumber}&comment={dealId}</code></p>
				<div style="margin-top:18px; display:flex; gap:12px; align-items:center; flex-wrap: wrap;">
					<button class="primary" id="btnAddAccount">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</button>
					<div id="accountMessage"></div>
				</div>
			</div>

			<div class="card">
				<h2 class="section-title">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</h2>
				<div id="accountsContainer">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤</div>
			</div>
		</section>

		<section id="tab-settings" class="tab-content">
			<div class="card">
				<h2 class="section-title">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π</h2>
				<div class="flex-between">
					<div>
						<div class="small-text">–°–µ–∫—Ä–µ—Ç –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</div>
						<div id="configSecret" class="copy-target">‚Äî</div>
					</div>
					<button class="secondary" data-copy-target="configSecret">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
				</div>
				<hr style="margin:20px 0;border:none;border-top:1px solid #e5e7eb;" />
				<div class="flex-between">
					<div>
						<div class="small-text">Endpoint –¥–ª—è QR</div>
						<div id="configEndpoint" class="copy-target">‚Äî</div>
					</div>
					<button class="secondary" data-copy-target="configEndpoint">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
				</div>
				<hr style="margin:20px 0;border:none;border-top:1px solid #e5e7eb;" />
				<div style="margin-top:20px;">
					<button class="primary" id="btnGenerateConnectQr">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å QR –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</button>
					<div id="connectQrArea" class="qr-area" style="margin-top:20px;">
						<div class="qr-holder"></div>
						<pre></pre>
					</div>
				</div>
				<div style="margin-top:20px;" class="small-text">
					–ê–≤—Ç–æ–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–∞—è–≤–æ–∫ —á–µ—Ä–µ–∑ <span id="configTimeout">15</span> –º–∏–Ω—É—Ç.
				</div>
			</div>

			<div class="card">
				<h2 class="section-title">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é</h2>
				<ol class="small-text" style="line-height:1.8;">
					<li><strong>–°–æ–∑–¥–∞–π—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã:</strong> –Ω–∞ –≤–∫–ª–∞–¥–∫–µ ¬´–†–µ–∫–≤–∏–∑–∏—Ç—ã¬ª –¥–æ–±–∞–≤—å—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è (–Ω–∞–∑–≤–∞–Ω–∏–µ, –±–∞–Ω–∫, –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã/—Å—á—ë—Ç–∞).</li>
					<li><strong>–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:</strong> –Ω–∞–∂–º–∏—Ç–µ ¬´–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å QR –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è¬ª –≤—ã—à–µ, –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ RTD automatic (–º–µ–Ω—é ‚Üí ¬´–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã¬ª).</li>
					<li><strong>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:</strong> –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–¢–µ—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ¬ª ‚Äî —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ—è–≤–∏—Ç—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫–µ ¬´–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞¬ª –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω–æ–µ.</li>
					<li><strong>–ù–∞–∑–Ω–∞—á—å—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É:</strong> –Ω–∞ –≤–∫–ª–∞–¥–∫–µ ¬´–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞¬ª –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –≤–∞—à–µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.</li>
					<li><strong>–°–æ–∑–¥–∞–π—Ç–µ –∑–∞—è–≤–∫—É:</strong> –≤—ã–±–µ—Ä–∏—Ç–µ —Å—É–º–º—É, —Ä–µ–∫–≤–∏–∑–∏—Ç –∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ). –ù–∞–∂–º–∏—Ç–µ ¬´–û—Ç–∫—Ä—ã—Ç—å –æ–ø–ª–∞—Ç—É¬ª –∏ –æ–ø–ª–∞—Ç–∏—Ç–µ —á–µ—Ä–µ–∑ –ú-–ë–∞–Ω–∫.</li>
					<li><strong>–ê–≤—Ç–æ–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ:</strong> –∫–æ–≥–¥–∞ –ø—Ä–∏–¥—ë—Ç push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å —Ç–æ–π –∂–µ —Å—É–º–º–æ–π, –∑–∞—è–≤–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ï—Å–ª–∏ –Ω–µ –ø—Ä–∏–¥—ë—Ç ‚Äî –∑–∞—è–≤–∫–∞ –∑–∞–∫—Ä–æ–µ—Ç—Å—è —á–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç.</li>
				</ol>
				<p class="small-text" style="margin-top:16px; padding:12px; background:#fff8eb; border-radius:8px;">
					<strong>üí° –°–æ–≤–µ—Ç:</strong> –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å—É–º–º–∞ –≤ –∑–∞—è–≤–∫–µ —Ç–æ—á–Ω–æ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Å—É–º–º–æ–π –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "10" –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å "10", –∞ –Ω–µ "10,00"). –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç—ã.
				</p>
			</div>
		</section>
	</main>

	<!-- QRCode library - –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ CDN –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ -->
	<script>
		// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ QRCode –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
		function loadQRCodeLibrary(callback) {
			if (typeof QRCode !== 'undefined') {
				callback()
				return
			}
			
			const scripts = [
				'https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js',
				'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js'
			]
			
			let scriptIndex = 0
			
			function tryLoadScript() {
				if (scriptIndex >= scripts.length) {
					console.error('Failed to load QRCode library from all CDNs')
					callback(false)
					return
				}
				
				const script = document.createElement('script')
				script.src = scripts[scriptIndex]
				script.crossOrigin = 'anonymous'
				script.onload = function() {
					if (typeof QRCode !== 'undefined') {
						console.log('QRCode library loaded successfully')
						callback(true)
					} else {
						scriptIndex++
						tryLoadScript()
					}
				}
				script.onerror = function() {
					console.warn('Failed to load QRCode from', scripts[scriptIndex])
					scriptIndex++
					tryLoadScript()
				}
				document.head.appendChild(script)
			}
			
			tryLoadScript()
		}
	</script>
	<script>
		const API_BASE = '/api'
		const state = {
			config: null,
			accounts: [],
			devices: [],
			deals: []
		}

		const tabButtons = document.querySelectorAll('.tab-button')
		tabButtons.forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)))

		function switchTab(tabId) {
			tabButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabId))
			document.querySelectorAll('.tab-content').forEach(section => {
				section.classList.toggle('active', section.id === `tab-${tabId}`)
			})
		}

		async function api(url, options = {}) {
			const res = await fetch(url, {
				headers: { 'Content-Type': 'application/json' },
				...options
			})
			const data = await res.json().catch(() => ({}))
			if (!res.ok) {
				throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞')
			}
			return data
		}

		function setMessage(elementId, type, text) {
			const el = document.getElementById(elementId)
			if (!el) return
			if (!text) {
				el.innerHTML = ''
				return
			}
			el.innerHTML = `<div class="message ${type}">${text}</div>`
		}

		async function loadConfig() {
			const data = await api(`${API_BASE}/config`)
			state.config = data
			document.getElementById('configSecret').textContent = data.secret
			document.getElementById('configEndpoint').textContent = data.endpoint
			document.getElementById('configTimeout').textContent = data.autoRejectMinutes
		}

		async function loadAccounts() {
			const data = await api(`${API_BASE}/accounts`)
			state.accounts = data.accounts || []
			renderAccounts()
			populateAccountSelects()
		}

		async function loadDevices() {
			const data = await api(`${API_BASE}/devices`)
			state.devices = data.devices || []
			renderDevices()
			populateDeviceSelects()
		}

		async function loadDeals() {
			const data = await api(`${API_BASE}/deals`)
			state.deals = data.deals || []
			renderDeals()
		}

		function populateAccountSelects() {
			const dealSelect = document.getElementById('dealAccount')
			const deviceSelect = document.getElementById('deviceAccountSelect')
			const accountOptions = state.accounts.map(account => `<option value="${account.id}">${account.label}</option>`)
			dealSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</option>' + accountOptions.join('')
			deviceSelect.innerHTML = '<option value="">–ë–µ–∑ —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤</option>' + accountOptions.join('')
		}

		function populateDeviceSelects() {
			const dealDevice = document.getElementById('dealDevice')
			const options = state.devices.map(device => {
				const status = device.status === 'active' ? '–∞–∫—Ç–∏–≤–µ–Ω' : '–æ–∂–∏–¥–∞–µ—Ç'
				return `<option value="${device.id}">${device.label || device.id} (${status})</option>`
			})
			dealDevice.innerHTML = '<option value="">–ë–µ–∑ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</option>' + options.join('')
		}

		function renderAccounts() {
			const container = document.getElementById('accountsContainer')
			if (!state.accounts.length) {
				container.innerHTML = '<p class="small-text">–†–µ–∫–≤–∏–∑–∏—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>'
				return
			}
			container.innerHTML = state.accounts.map(account => `
				<div class="account-card">
					<div class="flex-between">
						<strong>${account.label}</strong>
						<span class="badge">ID ${account.id}</span>
					</div>
					<p class="small-text">–ë–∞–Ω–∫: ${account.bank || '‚Äî'} ¬∑ –ù–æ–º–µ—Ä: ${account.number || '‚Äî'}</p>
					<p class="small-text">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —à–∞–±–ª–æ–Ω –ú-–ë–∞–Ω–∫–∞: <code>mbank://transfer?amount={amount}&to={accountNumber}&comment={dealId}</code></p>
				</div>
			`).join('')
		}

		function renderDevices() {
			const container = document.getElementById('devicesContainer')
			if (!state.devices.length) {
				container.innerHTML = '<p class="small-text">–£—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>'
				return
			}
			container.innerHTML = state.devices.map(device => {
				const accountLabel = device.accountLabel || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ'
				const statusLabel = device.status === 'active' ? '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω' : '–û–∂–∏–¥–∞–µ—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏–∏'
				const statusClass = device.status === 'active' ? 'status-success' : 'status-pending'
				const lastSeen = device.lastSeen ? new Date(device.lastSeen).toLocaleString('ru-RU') : '‚Äî'
				const selectOptions = ['<option value="">–ë–µ–∑ —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤</option>'].concat(state.accounts.map(account => `<option value="${account.id}" ${account.id === device.accountId ? 'selected' : ''}>${account.label}</option>`))
				return `
					<div class="device-card" data-device="${device.id}">
						<div class="device-header">
							<div>
								<strong>${device.label || device.id}</strong>
								<div class="small-text">ID: ${device.id}</div>
							</div>
							<span class="status-badge ${statusClass}">${statusLabel}</span>
						</div>
						<p class="small-text">–†–µ–∫–≤–∏–∑–∏—Ç—ã: <strong>${accountLabel}</strong></p>
						<p class="small-text">–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${lastSeen}</p>
						<div class="form-grid" style="margin-top:12px;">
							<div>
								<label>–ù–∞–∑–Ω–∞—á–∏—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</label>
								<select class="device-account-select">${selectOptions.join('')}</select>
							</div>
						</div>
						<div class="deal-actions">
							<button class="small-button btn-open" data-action="assign">–ù–∞–∑–Ω–∞—á–∏—Ç—å</button>
							<button class="small-button btn-outline" data-action="activate">–ü–æ–º–µ—Ç–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–º</button>
							<button class="small-button btn-copy" data-action="qr">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å QR</button>
						</div>
						<div class="qr-area" id="qr-${device.id}">
							<div class="qr-holder"></div>
							<pre></pre>
						</div>
					</div>
				`
			}).join('')

			container.querySelectorAll('.device-card').forEach(card => {
				const deviceId = card.dataset.device
				card.querySelectorAll('[data-action]').forEach(button => {
					button.addEventListener('click', () => handleDeviceAction(deviceId, button.dataset.action, card))
				})
			})
		}

		async function handleDeviceAction(deviceId, action, card) {
			try {
				if (action === 'assign') {
					const select = card.querySelector('.device-account-select')
					const accountId = select.value
					await api(`${API_BASE}/device/${deviceId}/account`, {
						method: 'POST',
						body: JSON.stringify({ accountId })
					})
					await loadDevices()
					return
				}
				if (action === 'activate') {
					await api(`${API_BASE}/device/${deviceId}/activate`, { method: 'POST', body: JSON.stringify({}) })
					await loadDevices()
					return
				}
				if (action === 'qr') {
					// –ü—Ä–æ—Å—Ç–æ–π QR —Ç–æ–ª—å–∫–æ —Å endpoint –∏ secret (–±–µ–∑ deviceId –∏ account)
					const payload = {
						endpoint: state.config?.endpoint || `${window.location.origin}/notify`,
						secret: state.config?.secret
					}
					const qrArea = document.getElementById(`qr-${deviceId}`)
					const holder = qrArea.querySelector('.qr-holder')
					holder.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>'
					
					// –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É QRCode –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR
					loadQRCodeLibrary(function(success) {
						if (!success || typeof QRCode === 'undefined') {
							holder.innerHTML = '<p style="color:red; padding:10px;">–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É QRCode.</p>'
							qrArea.querySelector('pre').textContent = JSON.stringify(payload, null, 2)
							qrArea.classList.add('active')
							return
						}
						
						holder.innerHTML = ''
						try {
							new QRCode(holder, {
								text: JSON.stringify(payload),
								width: 180,
								height: 180,
								colorDark: '#1f2937',
								colorLight: '#ffffff'
							})
							qrArea.querySelector('pre').textContent = JSON.stringify(payload, null, 2)
							qrArea.classList.add('active')
						} catch (err) {
							console.error('Error generating QR code:', err)
							holder.innerHTML = '<p style="color:red; padding:10px;">–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR: ' + err.message + '</p>'
							qrArea.querySelector('pre').textContent = JSON.stringify(payload, null, 2)
							qrArea.classList.add('active')
						}
					})
				}
			} catch (err) {
				alert(err.message)
			}
		}

		function renderDeals() {
			const container = document.getElementById('dealsContainer')
			if (!state.deals.length) {
				container.innerHTML = '<p class="small-text">–ó–∞—è–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç.</p>'
				return
			}

			const autoRejectMs = (state.config?.autoRejectMinutes || 15) * 60 * 1000
			container.innerHTML = state.deals.map(deal => {
				const createdAt = new Date(deal.createdAt)
				const expiresAt = new Date(createdAt.getTime() + autoRejectMs)
				const timeLeftMs = expiresAt - Date.now()
				let timeLeft = ''
				if (deal.status === 'pending' && timeLeftMs > 0) {
					const minutes = Math.floor(timeLeftMs / 60000)
					const seconds = Math.floor((timeLeftMs % 60000) / 1000)
					timeLeft = `${minutes}:${seconds.toString().padStart(2, '0')}`
				}
				const statusClass = deal.statusColor === 'success' ? 'status-success' : deal.statusColor === 'error' ? 'status-error' : 'status-pending'
				const statusLabel = deal.statusLabel || '–û–∂–∏–¥–∞–Ω–∏–µ'
				const paymentLinkHtml = deal.paymentLink ? `<button class="small-button btn-open" data-open="${deal.paymentLink}">–û—Ç–∫—Ä—ã—Ç—å –æ–ø–ª–∞—Ç—É</button>` : ''
				const copyLinkHtml = deal.paymentLink ? `<button class="small-button btn-copy" data-copy="${deal.paymentLink}">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>` : ''
				const matchInfo = deal.match ? `<p class="small-text">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º: ${deal.match.title || '‚Äî'}</p>` : ''
				return `
					<div class="deal-card" data-deal="${deal.id}">
						<div class="deal-header">
							<div>
								<strong>#${deal.id}</strong>
								<div class="small-text">–°–æ–∑–¥–∞–Ω–æ: ${createdAt.toLocaleString('ru-RU')}</div>
							</div>
							<span class="status-badge ${statusClass}">${statusLabel}</span>
						</div>
						<p class="small-text"><strong>–°—É–º–º–∞:</strong> ${deal.amount} ¬∑ <strong>–†–µ–∫–≤–∏–∑–∏—Ç—ã:</strong> ${deal.accountLabel || '‚Äî'}</p>
						<p class="small-text"><strong>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:</strong> ${deal.deviceLabel || deal.deviceId || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
						${deal.paymentLink ? `<p class="small-text">–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É: <code>${deal.paymentLink}</code></p>` : ''}
						${matchInfo}
						${deal.status === 'pending' && timeLeft ? `<p class="small-text">‚è± –î–æ —Ç–∞–π–º–∞—É—Ç–∞: ${timeLeft}</p>` : ''}
						<div class="deal-actions">
							${paymentLinkHtml}
							${copyLinkHtml}
							${deal.status === 'pending' ? `<button class="small-button btn-open" data-action="close">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>` : ''}
							${deal.status === 'pending' ? `<button class="small-button btn-danger" data-action="reject">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>` : ''}
						</div>
					</div>
				`
			}).join('')

			container.querySelectorAll('[data-open]').forEach(btn => {
				btn.addEventListener('click', () => window.open(btn.dataset.open, '_blank'))
			})
			container.querySelectorAll('[data-copy]').forEach(btn => {
				btn.addEventListener('click', () => copyText(btn.dataset.copy))
			})
			container.querySelectorAll('.deal-card').forEach(card => {
				const dealId = card.dataset.deal
				card.querySelectorAll('[data-action]').forEach(button => {
					button.addEventListener('click', () => handleDealAction(dealId, button.dataset.action))
				})
			})
		}

		async function handleDealAction(dealId, action) {
			try {
				if (action === 'close') {
					await api(`${API_BASE}/deal/${dealId}/close`, { method: 'POST', body: JSON.stringify({}) })
				} else if (action === 'reject') {
					await api(`${API_BASE}/deal/${dealId}/reject`, { method: 'POST', body: JSON.stringify({ reason: 'manual' }) })
				}
				await loadDeals()
			} catch (err) {
				alert(err.message)
			}
		}

		async function createDeal() {
			try {
				const amount = document.getElementById('dealAmount').value.trim()
				const accountId = document.getElementById('dealAccount').value
				const deviceId = document.getElementById('dealDevice').value
				if (!amount) throw new Error('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É')
				if (!accountId) throw new Error('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã')
				const payload = { amount, accountId, deviceId }
				await api(`${API_BASE}/deal`, {
					method: 'POST',
					body: JSON.stringify(payload)
				})
				setMessage('dealMessage', 'success', '–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞')
				document.getElementById('dealAmount').value = ''
				await loadDeals()
			} catch (err) {
				setMessage('dealMessage', 'error', err.message)
			}
		}

		async function addDevice() {
			try {
				const id = document.getElementById('deviceIdInput').value.trim()
				const label = document.getElementById('deviceLabelInput').value.trim()
				const accountId = document.getElementById('deviceAccountSelect').value
				if (!id) throw new Error('–í–≤–µ–¥–∏—Ç–µ ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞')
				await api(`${API_BASE}/device`, {
					method: 'POST',
					body: JSON.stringify({ deviceId: id, label, accountId })
				})
				setMessage('deviceMessage', 'success', '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ')
				document.getElementById('deviceIdInput').value = ''
				document.getElementById('deviceLabelInput').value = ''
				document.getElementById('deviceAccountSelect').value = ''
				await loadDevices()
			} catch (err) {
				setMessage('deviceMessage', 'error', err.message)
			}
		}

		async function addAccount() {
			try {
				const name = document.getElementById('accountName').value.trim()
				const bank = document.getElementById('accountBank').value.trim()
				const number = document.getElementById('accountNumber').value.trim()
				await api(`${API_BASE}/account`, {
					method: 'POST',
					body: JSON.stringify({ name, bank, number })
				})
				setMessage('accountMessage', 'success', '–†–µ–∫–≤–∏–∑–∏—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã')
				document.getElementById('accountName').value = ''
				document.getElementById('accountBank').value = ''
				document.getElementById('accountNumber').value = ''
				await loadAccounts()
			} catch (err) {
				setMessage('accountMessage', 'error', err.message)
			}
		}

		function copyText(text) {
			navigator.clipboard.writeText(text).then(() => {
				alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞')
			}).catch(() => alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'))
		}

		document.getElementById('btnCreateDeal').addEventListener('click', createDeal)
		document.getElementById('btnAddDevice').addEventListener('click', addDevice)
		document.getElementById('btnAddAccount').addEventListener('click', addAccount)
		document.getElementById('btnGenerateConnectQr').addEventListener('click', () => {
			const payload = {
				endpoint: state.config?.endpoint || `${window.location.origin}/notify`,
				secret: state.config?.secret
			}
			const qrArea = document.getElementById('connectQrArea')
			const holder = qrArea.querySelector('.qr-holder')
			holder.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>'
			
			// –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É QRCode –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR
			loadQRCodeLibrary(function(success) {
				if (!success || typeof QRCode === 'undefined') {
					holder.innerHTML = '<p style="color:red; padding:20px;">–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É QRCode. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.</p><p style="margin-top:10px;">–í—ã –º–æ–∂–µ—Ç–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å JSON –Ω–∏–∂–µ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –≤—Ä—É—á–Ω—É—é:</p>'
					qrArea.querySelector('pre').textContent = JSON.stringify(payload, null, 2)
					qrArea.classList.add('active')
					return
				}
				
				holder.innerHTML = ''
				try {
					new QRCode(holder, {
						text: JSON.stringify(payload),
						width: 200,
						height: 200,
						colorDark: '#1f2937',
						colorLight: '#ffffff'
					})
					qrArea.querySelector('pre').textContent = JSON.stringify(payload, null, 2)
					qrArea.classList.add('active')
				} catch (err) {
					console.error('Error generating QR code:', err)
					holder.innerHTML = '<p style="color:red; padding:20px;">–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR: ' + err.message + '</p>'
					qrArea.querySelector('pre').textContent = JSON.stringify(payload, null, 2)
					qrArea.classList.add('active')
				}
			})
		})
		document.querySelectorAll('[data-copy-target]').forEach(btn => {
			btn.addEventListener('click', () => {
				const targetId = btn.getAttribute('data-copy-target')
				const value = document.getElementById(targetId)?.textContent
				if (value) copyText(value)
			})
		})

		async function init() {
			try {
				await loadConfig()
				await loadAccounts()
				await loadDevices()
				await loadDeals()
				setInterval(() => {
					loadDeals()
					loadDevices()
				}, 7000)
			} catch (err) {
				console.error(err)
				alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã: ' + err.message)
			}
		}

		init()
	</script>
</body>
</html>

