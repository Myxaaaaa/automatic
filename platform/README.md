# RTD Platform

Веб-платформа для управления устройствами, реквизитами и заявками, которые автоматически закрываются после поступления push-уведомления из Android-приложения **RTD automatic**.

## Основные возможности

- ✅ Панель с вкладками: «Заявки», «Устройства», «Реквизиты», «Настройки»
- ✅ Создание заявок с выбором реквизитов и устройства
- ✅ Генерация ссылки на оплату по шаблону (под М-Банк или другой сервис)
- ✅ Генерация QR-кода для подключения устройства (endpoint + secret + реквизиты)
- ✅ Автоподтверждение заявки при совпадении суммы/устройства/реквизитов по push
- ✅ Ручное подтверждение/отклонение, автоотклонение через 15 минут
- ✅ Живые списки устройств, реквизитов и заявок (автообновление)

## Установка

```bash
cd platform
npm install
```

## Запуск

```bash
npm start
```

Платформа откроется на `http://localhost:3001` (порт можно заменить через `.env`).

## Вкладки веб-интерфейса

### 1. Заявки
- Выберите сумму, реквизит и устройство (опционально)
- Получите ссылку на оплату, откройте её в браузере/банке
- Заявка автоматически подтвердится при поступлении push с той же суммой
- Не пришёл push? Можно подтвердить или отклонить вручную
- Через 15 минут без события заявка отклонится автоматически

### 2. Устройства
- Добавление устройств (ID + человеко-читаемое имя)
- Назначение реквизитов и генерация QR-кода для приложения
- Отображение статуса: активировано или ожидает
- Поле «Последняя активность» показывает время последнего push/ручного действия

### 3. Реквизиты
- Добавьте получателя: название, банк, номер (карта/счёт) и шаблон ссылки
- Шаблон поддерживает плейсхолдеры: `{amount}`, `{dealId}`, `{accountNumber}`
- Пример шаблона: `https://mbank.example/pay?account={accountNumber}&amount={amount}&deal={dealId}`
- Реквизиты можно назначать устройствам и использовать в заявках

### 4. Настройки
- Отображает `secret`, `endpoint` (`https://host/notify`) и таймаут автоотклонения
- Быстрые инструкции по подключению приложения RTD automatic

## API (REST)

### Конфигурация
```
GET /api/config
```
Возвращает endpoint, секрет и таймаут.

### Реквизиты
```bash
POST /api/account
{
  "name": "ООО RTD",
  "bank": "МБанк",
  "number": "40817810...",
  "paymentTemplate": "https://mbank.example/pay?account={accountNumber}&amount={amount}&deal={dealId}"
}
```

### Устройства
```bash
POST /api/device
{
  "deviceId": "android-device-01",
  "label": "Рабочий телефон",
  "accountId": "1"
}

POST /api/device/:id/account   # назначить реквизиты
POST /api/device/:id/activate  # пометить как активное
```

### Заявки
```bash
POST /api/deal
{
  "amount": "1234,56",
  "accountId": "1",
  "deviceId": "android-device-01"   // опционально
}

GET  /api/deals
POST /api/deal/:id/close
POST /api/deal/:id/reject
```

### Push-уведомление от приложения
```bash
POST /notify
Authorization: Bearer <SECRET>
Content-Type: application/json

{
  "amount": "1234,56",
  "title": "МБанк",
  "text": "Поступление 1234,56 ₽",
  "package": "ru.mbank",
  "postedAt": "2025-01-25T12:34:56Z",
  "deviceId": "android-device-01",
  "account": "ООО RTD · МБанк · ••1234"
}
```
- `amount` — обязательный параметр, сравнивается без пробелов (запятая допустима)
- `deviceId` и `account` помогают различать устройства и реквизиты
- Совпадение по сумме/устройству/реквизиту подтверждает заявку

## Подключение Android-приложения
1. Откройте вкладку «Устройства», назначьте реквизиты и нажмите «Сгенерировать QR»
2. Отсканируйте QR из приложения RTD automatic (QR содержит endpoint, secret, deviceId, account)
3. В приложении нажмите «Тест уведомление» — устройство появится как активное

## Настройки через `.env`
```env
PORT=3001
SECRET=test-secret
AUTO_REJECT_MINUTES=15
DEFAULT_PAYMENT_TEMPLATE=https://mbank.example/pay?account={accountNumber}&amount={amount}&deal={dealId}
```

- `SECRET` — ключ авторизации для приложения (QR содержит этот секрет)
- `AUTO_REJECT_MINUTES` — таймаут автоотклонения заявок
- `DEFAULT_PAYMENT_TEMPLATE` — шаблон по умолчанию, если не указан на вкладке «Реквизиты»

## Советы
- Рекомендуется запускать платформу и приложение в одной сети (Wi-Fi) и использовать `http://<IP>:3001`
- В приложении можно проверять подключение кнопкой «Тест уведомление» — логи в платформе покажут событие
- Если нужно «деактивировать» устройство, уберите у него реквизиты и очистите подключение в приложении

